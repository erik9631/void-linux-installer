#!/bin/bash

#TODO
# Add nvidia drivers script

# shellcheck source=network
source "$SCRIPT_DIR/includes/network"

# shellcheck source=utils
source "$SCRIPT_DIR/includes/utils"

# shellcheck source=configs
source "$SCRIPT_DIR/includes/configs"

# shellcheck source=desktop
source "$SCRIPT_DIR/includes/desktop"

# shellcheck source=package_installer
source "$SCRIPT_DIR/includes/package_installer"

# shellcheck source=bootloader
source "$SCRIPT_DIR/includes/bootloader"

# shellcheck source=display
source "$SCRIPT_DIR/includes/display"

# shellcheck source=service
source "$SCRIPT_DIR/includes/service"

# shellcheck source=common
source "$SCRIPT_DIR/includes/common"


stage_zero(){
  # Check if the script is running as root
  local is_wireless
  local connection_state
  check_root_user
  if ! connection_state=$(handle_internet_connection); then
    exit 1
  fi
  is_wireless=$(echo "$connection_state" | grep -i -c 'wireless')

  if ((is_wireless)); then
    echo "Wireless connection detected."
  else
    echo "Wired connection detected."
  fi

  if findmnt -M "/mnt" >/dev/null; then
    echo "/mnt is mounted. Installing kernel..."
  else
    echo "/mnt is not mounted."
    exit 1
  fi
  local tar_path="$SCRIPT_DIR/../system.tar"

  # Install the tarbar
  if ! tar xvf "$tar_path" -C /mnt; then
    echo "Failed to extract system.tar." >&2
    exit 1
  fi

  echo "Generating file system table..."
  "$SCRIPT_DIR"/scripts/genfstab -U /mnt >>/mnt/etc/fstab

  copy_scripts /mnt/bin/ /mnt/usr/lib/

  echo "Copying fonts..."
  mkdir -p /mnt/usr/share/fonts/
  if ! cp -rfv "$SCRIPT_DIR"/../fonts/* /mnt/usr/share/fonts/; then
    echo "Failed to copy fonts to /mnt/usr/share/fonts/" >&2
    exit 1
  fi

  local hostname
  local username
  local password

  read -p 'Set your hostname: ' hostname
  read -p 'Set your username: ' username
  read -sp 'Set your root password: ' password
  echo " " >&2

  export password
  export username

  local stage0_packages_str
  local boot_mode

  boot_mode=$(get_boot_mode)
  stage0_packages_str="$(export_package_group "stage0" "xbps")"

  export boot_mode

  ## TODO
  # Display manager not saving config
  # Add resolv.conf for NetworkManager

  xbps-install -Suy xbps
  xbps-install -y unzip

  # installs base-system and prepares grub
  x_chroot /mnt /bin/bash -c "
    if ! xbps-install -Suy xbps; then
        echo 'Failed to update xbps' >&2
        exit 1
    fi
    if ! xbps-install -uy; then
        echo 'Failed to update system' >&2
        exit 1
    fi
    if ! xbps-install -y base-system; then
        echo 'Failed to install base system' >&2
        exit 1
    fi
    if ! xbps-remove -y base-container-full; then
        echo 'Failed to remove base-container-full' >&2
        exit 1
    fi
    if ! xbps-install -y fontconfig; then
        echo 'Failed to install fontconfig' >&2
        exit 1
    fi

    echo 'Preparing grub...'
    if ! install_grub \"\$boot_mode\"; then
        echo 'Grub installation failed' >&2
        exit 1
    fi

    if ! xbps-reconfigure -fa; then
        echo 'xbps-reconfigure failed' >&2
        exit 1
    fi

    if ! xbps-install -Sy void-repo-nonfree void-repo-multilib{,-nonfree}; then
        echo 'Failed to install nonfree, multilib and nonfree repositories' >&2
        exit 1
    fi

    if ! xbps-install -Su; then
        echo 'Failed to update system after installing nonfree, multilib and nonfree repositories' >&2
        exit 1
    fi
  "

  # installs all the packages for the system
  echo 'Installing packages...'>&2
  if [[ -n "${stage0_packages_str}" ]]; then
    local stage0_packages
    local count=0
    readarray -t stage0_packages <<< "${stage0_packages_str}"
    echo 'Installing basic packages' >&2
    while ((count < 5)); do
    if ! install_xbps_packages stage0_packages /mnt; then
          echo 'Failed to install xbps packages...retrying' >&2
          ((count++))
          continue
      fi
      echo 'Successfully installed packages' >&2
      break
    done
  fi

  if ((count == 5)); then
    echo 'Failed to install packages. Check internet connection and try again.' >&2
    exit 1
  fi
  echo "Setting up hostname" >&2
  echo "$hostname" > /mnt/etc/hostname

  # Setups pipewire configuration so it properly works with pulse and alsa
  # Also setups up the initial user and his permissions
  # Lastly sets up basic services
  x_chroot /mnt /bin/bash -c "
    # Setup PipeWire system configuration
    if ! mkdir -p /etc/pipewire/pipewire.conf.d; then
      echo \"Failed to create pipewire folder\" >&2
    fi

    if ! ln -sv /usr/share/examples/wireplumber/10-wireplumber.conf /etc/pipewire/pipewire.conf.d/; then
      echo \"WirePlumber configuration failed to link\" >&2
    fi

    if ! ln -sv /usr/share/examples/pipewire/20-pipewire-pulse.conf /etc/pipewire/pipewire.conf.d/; then
      echo \"Pipewire configuration failed to link\" >&2
    fi

    if ! mkdir -p /etc/alsa/conf.d; then
      echo \"Failed to create alsa config directory\" >&2
    fi

    if ! ln -sv /usr/share/alsa/alsa.conf.d/50-pipewire.conf /etc/alsa/conf.d/; then
      echo \"Failed to link ALSA pipewire config\" >&2
    fi

    if ! ln -sv /usr/share/alsa/alsa.conf.d/99-pipewire-default.conf /etc/alsa/conf.d/; then
      echo \"Failed to link ALSA pipewire default config\" >&2
    fi

    # Setup users and passwords
    echo \"root:\$password\" | chpasswd -c SHA512
    echo 'Setting up new user...' >&2
    useradd -m \"\$username\"
    echo \"\$username:\$password\" | chpasswd -c SHA512
    usermod -aG wheel \"\$username\"
    usermod -aG audio \"\$username\"
    usermod -aG video \"\$username\"
    sed -i '/^#\s*%wheel ALL=(ALL:ALL) ALL/s/^# //' /etc/sudoers

    # Setup services
    echo 'Performing services setup...'>&2
    for svc in dbus bluetoothd sddm NetworkManager chronyd rtkit polkitd; do
        if ! service -c /etc/runit/runsvdir/default/ \$svc; then
            echo \"Warning: Failed to enable \$svc\" >&2
        fi
    done

    # Download nnn plugins
    curl -Ls https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs | sh

    # Setup user environment and configs (all inside chroot with proper ownership)
    echo 'Configuring user environment...' >&2

    # Bashrc additions
    echo \"export EDITOR='/bin/nvim'\" >> \"/home/\$username/.bashrc\"
    echo \"bind 'set enable-bracketed-paste off'\" >> \"/home/\$username/.bashrc\"

    # Setup KDE config directory
    mkdir -p \"/home/\$username/.config\"

    # Enable PipeWire autostart
    mkdir -p \"/home/\$username/.config/autostart/\"
    ln -s /usr/share/applications/pipewire.desktop \"/home/\$username/.config/autostart/\"

    # Set alacritty as default terminal
    cat >> \"/home/\$username/.config/kdeglobals\" << 'EOFKDE'
[General]
TerminalApplication=alacritty
TerminalService=
BrowserApplication=!dolphin.desktop
EOFKDE

    # Fix all ownership for user home directory
    chown -R \"\$username:\$username\" \"/home/\$username\"
    chmod -R u+rw \"/home/\$username/.config\"
  "

  copy_configs "/mnt/home/$username" "$username"
  copy_desktop_files


  mkdir -p /mnt/etc/NetworkManager/
  cat > /mnt/etc/NetworkManager/NetworkManager.conf << 'EOF'
[main]
dns=default
rc-manager=file

[logging]
level=INFO
EOF

  # Remove any symlink and create regular file
  if [ -L /mnt/etc/resolv.conf ]; then
    rm /mnt/etc/resolv.conf
  fi

  # Write fallback DNS (NetworkManager will replace on first connection)
  echo "nameserver 8.8.8.8" > /mnt/etc/resolv.conf
  echo "nameserver 1.1.1.1" >> /mnt/etc/resolv.conf
  echo 'Creating rc.local for sound device permissions fix...' >&2
  cat > /mnt/etc/rc.local << 'EOFRC'
#!/bin/sh
echo "=== RC.LOCAL START at $(cat /proc/uptime) ===" > /var/log/rclocal.log
ls -la /dev/snd/controlC0 >> /var/log/rclocal.log 2>&1
sleep 3
echo "=== RC.LOCAL AFTER SLEEP at $(cat /proc/uptime) ===" >> /var/log/rclocal.log
ls -la /dev/snd/controlC0 >> /var/log/rclocal.log 2>&1
EOFRC
  chmod +x /mnt/etc/rc.local

  # TEMPORARY FIX: Remove problematic KWallet portal service file
  # This fixes KWallet PAM auto-unlock and NetworkManager WiFi password retrieval
  # Issue: https://github.com/void-linux/void-packages/issues/57348
  # Root cause: kf6-kwallet 6.18 introduced a portal service that causes a race condition
  # with pam_kwallet5, preventing auto-unlock at login
  # Trade-off: Sandboxed apps (Flatpak/Snap) won't be able to use KWallet through portal
  # TODO: Remove this workaround once upstream bug is fixed
  echo 'Applying temporary KWallet PAM integration fix...' >&2
  if [ -f /mnt/usr/share/dbus-1/services/org.freedesktop.impl.portal.desktop.kwallet.service ]; then
    rm /mnt/usr/share/dbus-1/services/org.freedesktop.impl.portal.desktop.kwallet.service
    echo 'KWallet portal service file removed (temporary workaround)' >&2
  else
    echo 'KWallet portal service file not found (may already be fixed upstream)' >&2
  fi

  echo 'Install complete. Rebooting into the system'
  sleep 5
  # shutdown -r now
}